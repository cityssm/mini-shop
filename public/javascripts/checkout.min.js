"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))(function(a,s){function n(e){try{c(o.next(e))}catch(e){s(e)}}function i(e){try{c(o.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(n,i)}c((o=o.apply(e,t||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{const e=document.querySelector("main").getAttribute("data-url-prefix");let t={};const r=document.getElementById("card--cart"),o=document.getElementById("container--cartTotal"),a=document.getElementById("form--shipping");let s={itemTotal:0,feeTotals:{}},n=[];const i=e=>{e.preventDefault();const r=parseInt(e.currentTarget.getAttribute("data-cart-index"),10),o=n[r],a=t.products[o.productSKU];cityssm.confirmModal('Remove "'+a.productName+'"?',"Are you sure you want to remove this item from your cart?","Yes, Remove It","warning",()=>{exports.cart.remove(r),d()})},c=(e,o)=>{const a=t.products[e.productSKU];a||(exports.cart.clear(),location.reload());const n=document.createElement("li");if(n.className="card-content",n.innerHTML='<div class="columns"><div class="column is-narrow has-text-right"><button class="button is-inverted is-danger has-tooltip-arrow has-tooltip-right has-tooltip-hidden-mobile" data-cart-index="'+o.toString()+'" data-tooltip="Remove from Cart" type="button" aria-label="Remove from Cart"><i class="fas fa-times" aria-hidden="true"></i><span class="is-hidden-tablet ml-2">Remove from Cart</span></button></div><div class="column"><strong class="container--productName"></strong><br /><div class="is-size-7 container--formFields"></div></div><div class="column is-narrow column--quantity has-text-right"></div><div class="column is-narrow column--price has-text-weight-bold has-text-right"></div></div>',n.getElementsByTagName("button")[0].addEventListener("click",i),n.getElementsByClassName("container--productName")[0].innerText=a.productName,a.formFieldsToSave&&a.formFieldsToSave.length>0){const t=n.getElementsByClassName("container--formFields")[0];for(const r of a.formFieldsToSave)if(e[r.formFieldName]){t.insertAdjacentHTML("beforeend","<strong>"+r.fieldName+":</strong> ");const o=document.createElement("span");o.innerText=e[r.formFieldName],t.appendChild(o),t.insertAdjacentHTML("beforeend","<br />")}}const c=n.getElementsByClassName("column--quantity")[0],d="number"==typeof a.price?a.price:parseFloat(e.unitPrice);c.innerText=e.quantity+" Ã— $"+d.toFixed(2);const l=d*parseInt(e.quantity,10);if(n.getElementsByClassName("column--price")[0].innerText="$"+l.toFixed(2),r.appendChild(n),s.itemTotal+=l,a.feeTotals&&Object.keys(a.feeTotals).length>0)for(const e of Object.keys(a.feeTotals))s.feeTotals[e]=(s.feeTotals[e]||0)+a.feeTotals[e]},d=()=>{cityssm.clearElement(r),cityssm.clearElement(o),s={itemTotal:0,feeTotals:{}},0===(n=exports.cart.get()).length?(r.classList.add("is-hidden"),a.classList.add("is-hidden"),document.getElementById("button--clearCart").classList.add("is-hidden"),r.insertAdjacentHTML("beforebegin",'<div class="message is-info"><div class="message-body has-text-centered"><p class="has-text-weight-bold">The cart is empty.</p><p><a href="'+cityssm.escapeHTML(e)+'/products">View Available Products</a></p></div></div>')):(n.forEach(c),r.classList.remove("is-hidden"),a.classList.remove("is-hidden"));let i=s.itemTotal;if(Object.keys(s.feeTotals).length>0){o.insertAdjacentHTML("beforeend",'<div class="has-text-weight-bold">Subtotal: $'+s.itemTotal.toFixed(2)+"</div>");for(const e of Object.keys(s.feeTotals))o.insertAdjacentHTML("beforeend","<div>"+t.fees[e].feeName+": $"+s.feeTotals[e].toFixed(2)+"</div>"),i+=s.feeTotals[e]}o.insertAdjacentHTML("beforeend",'<div class="is-size-4 has-text-weight-bold">Total: $'+i.toFixed(2)+"</div>"),o.insertAdjacentHTML("beforeend",'<div class="is-size-7 has-text-weight-bold">Prices in '+cityssm.escapeHTML(o.getAttribute("data-currency"))+"</div>")};let l=!1;a.addEventListener("submit",t=>{if(t.preventDefault(),l)return;l=!0;const r=formToObject(a);r.cartItems=exports.cart.get(),fetch(e+"/checkout/doCreateOrder",{method:"POST",body:JSON.stringify(r),headers:{"Content-Type":"application/json"}}).then(e=>__awaiter(void 0,void 0,void 0,function*(){return yield e.json()})).then(e=>{e.success?(document.getElementById("toPayment_orderNumber").value=e.orderNumber,document.getElementById("toPayment_orderSecret").value=e.orderSecret,document.getElementById("form--toPayment").submit()):(cityssm.alertModal("Order Error","An error occurred while trying to create your order. Please try again.","OK","danger"),l=!1)}).catch(e=>{cityssm.alertModal("Order Error","An error occurred while trying to create your order. Please try again.","OK","danger"),l=!1})}),(()=>{const r=(()=>{const e=new Set,t=exports.cart.get();for(const r of t)e.add(r.productSKU);return Array.from(e)})().join(",");""!==r?fetch(e+"/checkout/doGetProductDetails",{method:"POST",body:new URLSearchParams({productSKUs:r})}).then(e=>__awaiter(void 0,void 0,void 0,function*(){return yield e.json()})).then(e=>{t=e,d()}).catch(()=>{}):d()})(),document.getElementById("button--clearCart").addEventListener("click",()=>{cityssm.confirmModal("Clear Cart?","Are you sure you want to remove all items from your cart?","Yes, Clear the Cart","warning",()=>{exports.cart.clear(),d()})}),window.setTimeout(()=>{exports.cart.refresh()},3e5)})();